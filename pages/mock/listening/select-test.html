<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Select Listening Test</title>
    <link rel="stylesheet" href="../select-test.css" />
    <link rel="icon" href="/image/Logo.ver1.2.png" />
    <style>
      .test-card {
        position: relative;
        padding-bottom: 90px; /* Make room for result section */
      }

      .user-result {
        position: absolute;
        bottom: 20px;
        left: 20px;
        right: 20px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .user-result:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .user-result.no-result {
        background: #fef3c7;
        border-color: #fde68a;
        cursor: default;
        justify-content: center;
      }

      .user-result.no-result:hover {
        transform: none;
        box-shadow: none;
      }

      .result-score {
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
      }

      .no-result-text {
        font-size: 14px;
        color: #92400e;
        font-weight: 500;
      }

      .band-badge {
        padding: 8px 16px;
        border-radius: 24px;
        font-size: 12px;
        font-weight: 700;
        color: white;
        min-width: 80px;
        text-align: center;
      }

      .band-9 {
        background: linear-gradient(135deg, #10b981, #059669);
      }
      .band-8 {
        background: linear-gradient(135deg, #3b82f6, #1e40af);
      }
      .band-7 {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      }
      .band-6 {
        background: linear-gradient(135deg, #f59e0b, #d97706);
      }
      .band-5 {
        background: linear-gradient(135deg, #ef4444, #dc2626);
      }
      .band-low {
        background: linear-gradient(135deg, #6b7280, #4b5563);
      }
      .result-score {
        font-size: 14px;
      }
      .loading-result {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 20px;
        color: #64748b;
        font-size: 14px;
      }

      .spinner-small {
        width: 16px;
        height: 16px;
        border: 2px solid #f3f4f6;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <span
        ><img src="/image/logo.png" alt="" />
        <h1>Listening Tests</h1></span
      >
      <a href="/pages/mock.html" class="back-btn">🔙 Back to Mock</a>
    </div>

    <div class="subtitle">
      <p>Improve your listening skills with real IELTS audio materials</p>
    </div>

    <div class="tests-grid" id="test-buttons">
      <div id="loading" class="loading">
        <div class="spinner"></div>
        <div>Loading listening tests...</div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        query,
        where,
        orderBy,
        limit,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBw36xP5tVYO2D0T-XFQQAGFA4wrJ8If8k",
        authDomain: "yes-english-center.firebaseapp.com",
        projectId: "yes-english-center",
        storageBucket: "yes-english-center.appspot.com",
        messagingSenderId: "203211203853",
        appId: "1:203211203853:web:7d499925c3aa830eaefc44",
        measurementId: "G-4LHEBLG2KK",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth();
      function extractNumber(str) {
        // Ищем первое число в строке
        const match = str.match(/\d+/);
        return match ? parseInt(match[0], 10) : 0;
      }

      const container = document.getElementById("test-buttons");
      const loading = document.getElementById("loading");

      function convertToIELTS(score, total = 40) {
        const percent = (score / total) * 100;
        if (percent >= 90) return "9.0";
        if (percent >= 87.5) return "8.5";
        if (percent >= 80) return "8.0";
        if (percent >= 75) return "7.5";
        if (percent >= 70) return "7.0";
        if (percent >= 65) return "6.5";
        if (percent >= 60) return "6.0";
        if (percent >= 55) return "5.5";
        if (percent >= 50) return "5.0";
        if (percent >= 45) return "4.5";
        if (percent >= 40) return "4.0";
        return "Below 4.0";
      }

      function getBandClass(band) {
        const score = parseFloat(band);
        if (score >= 9.0) return "band-9";
        if (score >= 8.0) return "band-8";
        if (score >= 7.0) return "band-7";
        if (score >= 6.0) return "band-6";
        if (score >= 5.0) return "band-5";
        return "band-low";
      }

      async function getUserLatestResult(userId, testId) {
        try {
          console.log(
            "Searching for listening results - userId:",
            userId,
            "testId:",
            testId
          );

          // First try with userId
          let resultsQuery = query(
            collection(db, "resultsListening"),
            where("userId", "==", userId),
            where("testId", "==", testId),
            orderBy("createdAt", "desc"),
            limit(1)
          );

          let snapshot = await getDocs(resultsQuery);

          // If no results with userId, try with email in name field
          if (snapshot.empty) {
            const user = auth.currentUser;
            if (user && user.email) {
              console.log(
                "No results with userId, trying with email:",
                user.email
              );
              resultsQuery = query(
                collection(db, "resultsListening"),
                where("name", "==", user.email),
                where("testId", "==", testId),
                orderBy("createdAt", "desc"),
                limit(1)
              );
              snapshot = await getDocs(resultsQuery);
            }
          }

          // Debug: Check all user's results if none found for this test
          if (snapshot.empty) {
            console.log(
              "No results found with testId filter. Checking all user results..."
            );
            const allResultsQuery = query(
              collection(db, "resultsListening"),
              where("userId", "==", userId),
              orderBy("createdAt", "desc")
            );
            const allResults = await getDocs(allResultsQuery);

            if (!allResults.empty) {
              console.log(
                "User has listening results, but not for this testId. User's test IDs:"
              );
              allResults.forEach((doc) => {
                console.log(
                  "- testId:",
                  doc.data().testId,
                  "score:",
                  doc.data().score
                );
              });
            } else {
              // Try with name field
              const allResultsByName = await getDocs(
                query(
                  collection(db, "resultsListening"),
                  where("name", "==", auth.currentUser?.email || ""),
                  orderBy("createdAt", "desc")
                )
              );

              if (!allResultsByName.empty) {
                console.log("User has results by email, test IDs:");
                allResultsByName.forEach((doc) => {
                  console.log(
                    "- testId:",
                    doc.data().testId,
                    "score:",
                    doc.data().score
                  );
                });
              }
            }
          }

          if (!snapshot.empty) {
            const doc = snapshot.docs[0];
            console.log(
              "Found result for listening test",
              testId,
              ":",
              doc.data()
            );
            return {
              id: doc.id,
              ...doc.data(),
            };
          }

          console.log("No result found for listening test", testId);
          return null;
        } catch (error) {
          console.error(
            "Error fetching user result for listening test",
            testId,
            ":",
            error
          );
          return null;
        }
      }

      function createResultSection(result, testId) {
        if (!result) {
          return `
            <div class="user-result no-result">
              <div class="no-result-text">Take this test to see your score</div>
            </div>
          `;
        }

        const band = convertToIELTS(result.score, result.total || 40);
        const bandClass = getBandClass(band);

        return `
          <div class="user-result" data-result-id="${result.id}">
            <div class="result-score">${result.score}/${
          result.total || 40
        } correct</div>
            <div class="band-badge ${bandClass}">Band ${band}</div>
          </div>
        `;
      }

      async function loadListeningTests() {
        try {
          const user = await new Promise((resolve) => {
            onAuthStateChanged(auth, (user) => {
              if (!user) {
                console.log(
                  "❌ User not authenticated, redirecting to home page"
                );
                alert("🔒 Please login first to access listening tests");
                window.location.href = "/";
                return;
              }
              console.log("✅ User authenticated:", user.email);
              resolve(user);
            });
          });

          const testsSnapshot = await getDocs(collection(db, "listeningTests"));
          const tests = [];

          testsSnapshot.forEach((doc) => {
            tests.push({
              id: doc.id,
              data: doc.data(),
            });
          });

          tests.sort((a, b) => {
            const aId = a.data.testId || a.data.title || a.id;
            const bId = b.data.testId || b.data.title || b.id;

            const aNumber = extractNumber(aId);
            const bNumber = extractNumber(bId);

            return aNumber - bNumber;
          });

          loading.style.display = "none";

          if (tests.length === 0) {
            container.innerHTML = `
              <div class="no-tests">
                <h3>🎧 No listening tests available yet</h3>
                <p>Listening tests are coming soon! Check back later.</p>
              </div>
            `;
            return;
          }

          // Load all test cards first
          for (const [index, test] of tests.entries()) {
            const btn = document.createElement("button");
            btn.className = "test-card";

            const testTitle = test.data.title || `Listening Test ${index + 1}`;
            const testDescription =
              test.data.description ||
              "Complete IELTS listening practice with 4 sections and 40 questions.";

            btn.innerHTML = `
              <span class="test-icon">🎧</span>
              <div class="test-title">${testTitle}</div>
              <p class="test-subtitle">30 minutes • 40 questions</p>
              <span class="test-status available">Available</span>
              <div class="test-description">
                <h4>🎵 Test Overview</h4>
                <p>${testDescription}</p>
              </div>
              <div class="user-result-container" id="result-${test.id}">
                <div class="loading-result">
                  <div class="spinner-small"></div>
                  Loading your result...
                </div>
              </div>
            `;

            // Main button click - navigate to test
            btn.addEventListener("click", (e) => {
              // Check if click is on the result section
              if (
                !e.target.closest(".user-result") ||
                e.target.closest(".user-result.no-result")
              ) {
                console.log(`🎯 Starting listening test: ${test.id}`);
                window.location.href = `test.html?testId=${test.id}`;
              }
            });

            container.appendChild(btn);

            // Load user result asynchronously
            getUserLatestResult(user.uid, test.id).then((result) => {
              const resultContainer = document.getElementById(
                `result-${test.id}`
              );
              if (resultContainer) {
                resultContainer.innerHTML = createResultSection(
                  result,
                  test.id
                );

                // Add click handler for result section if result exists
                if (result) {
                  const resultElement =
                    resultContainer.querySelector(".user-result");
                  resultElement.addEventListener("click", (e) => {
                    e.stopPropagation();
                    window.location.href = `/pages/mock/listening/resultListening.html?id=${result.id}`;
                  });
                }
              }
            });
          }
        } catch (error) {
          console.error("Error loading listening tests:", error);
          loading.innerHTML = `
            <div class="error">
              <h3>❌ Error loading tests</h3>
              <p>Please try again later or contact support.</p>
            </div>
          `;
        }
      }

      // Initialize when page loads
      window.addEventListener("load", () => {
        console.log("🌐 Listening test selection page loaded");
        loadListeningTests();
      });
    </script>
  </body>
</html>
